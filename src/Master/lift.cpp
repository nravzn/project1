
class Lift(byte floors)
{

    const byte flag_topFloor = 150;
    const byte flag_oneFloorDown = 151;

    Lift::Lift(byte fl, byte dP, byte lP, byte cP, byte bD, byte bU, byte bS, byte bDL, byte bUL, byte bSL, byte p1, byte p2, byte p3, byte p4, byte sda, byte scl, byte arraySize) {
      byte noOfFloors = fl;
      byte dataPin = dP;
      byte latchPin = lP;
      byte clockPin = cP;
      byte buttonDown = bD;
      byte buttonUp = bU;
      byte buttonSet = bS;
      byte buttonDownLed = bDL;
      byte buttonUpLed = bUL;
      byte buttonSetLed = bSL;

      byte phase1 = p1;
      byte phase2 = p2;
      byte phase3 = p3;
      byte phase4 = p4;

      byte serialData = sda;
      byte serialClock = scl;

      byte arraySize;

      Motor motor = Motor(byte phase1, byte phase2, byte phase3, byte phase4);
      Coms Coms = Coms(byte noOfFloors, byte serialData, byte serialClock);
      Display display = Display(byte dataPin, byte latchPin, byte clockPin, byte dispAn1, byte dispAn2);
      Panel panel = Panel(byte bD, byte bU, byte bS, byte bDL, byte bUL, byte bSL);
      Route Route(byte ArraySize);


      ring_buffer_t startPoint;
      ring_buffer_t endPoint;

    }

    void Lift::initialize() {
      boolean operation = true;
      Motor.initRoutine(operation);
      byte foundFloor = Coms.scanAddress();
      Coms.setAddress(foundFloor);
      operation = false;
      for (int i = noOfFloors; i > 0; i--) {
        Motor.initRoutine(operation);
        foundFloor = Coms.scanAddress();
        Coms.setAddress(foundFloor);
      }
      return;
    }

    void Lift::moveTo(byte position, byte destination) {
      byte pulses = 0;
      byte nextFloor;
      boolean state = false;
      boolean lastState = false;
      boolean event = false;
      boolean speed = true;
      boolean direction;

      if (position < destination) {
        direction = false;
      }
      else {
        direction = true;
      }
      if (direction) {
        nextFloor = position + 1;
      }
      else {
        nextFloor = position - 1;
      }

      speed = Motor.start(direction);

      while (!event) {
        Motor.turn(direction, speed);
        Display::show();
        Coms::requestSlavePanel();
        state = Coms.getSensorState(nexFloor);
        if (state && !lastState) {
          pulses++;
          lastState = true;

          if (direction) {
            if (pulses == 1 && nextFloor + 1 == destination) {
              event = true;
            }
            if (pulses == 2) {
              pulses = 0;
              position++;
              nextFloor++;
              Display.set(position);
              Coms.announcePosition(position);
            }
            else {
              if (pulses == 1 && nextFloor - 1 == destination) {
                event = true;
              }
              if (pulses == 2) {
                pulses = 0;
                position--;
                nextFloor--;
                Display.set(position);
                Coms.announcePosition(position);
              }
            }
          }

        }
        else if (!state && lastState) {
          lastState = false;
        }
      }
      event = false;
      Motor.brake(direction);
      speed = false;

      while (!event) {
        Motor.turn(direction, speed);
        Display::show();
        Coms::getSlavePanel();
        state = Coms.getSensorState(nextFloor);
        if (state) {
          position++;
          Display::set(position);
          Coms::announcePosition(position);
          event = true;
        }
      }
      Motor.stop();
      return;
    }


    void Lift::getPanelStatus(byte position) {
      while (Display->dotMode) {
        byte state = Panel::readButtons();
        if (state == 2) {
          selection++;
        }
        else if (state == 3) {
          selection--;
        }
        else if (state == 4) {
          Display->dotMode = false;
          Route::addToRoute(selection);
        }
        Display::set(selection, true);
      }
      if (Panel::readButtons() == 4) {
        Display->dotMode = true;
      }
      return;
    }



































































//** STATEMACHINE IN STATEMACHINE???




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}

